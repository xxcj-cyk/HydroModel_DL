# 可微分新安江模型完整流程图

## 一、数据配置和样本计算

### 1.1 你的数据配置

```
输入数据：
- P（降水）
- PET（潜在蒸散发）
- 20个静态属性（流域特征）
- 612场洪水事件
- 每场洪水：720小时
- batch_size = 128
- forecast_length = 72（序列长度）
```

### 1.2 假设的配置参数

根据文档和代码逻辑，假设以下配置（请根据实际情况调整）：

```python
# 数据配置（data_cfgs）
warmup_length = 24        # 新安江模型预热期（24小时）
forecast_history = 0       # Decoder-only模式，不需要历史输入
forecast_length = 72       # 预测72小时（你设置的）

# 样本序列长度
sample_seqlen = warmup_length + forecast_history + forecast_length
                  = 24 + 0 + 72
                  = 96小时
```

### 1.3 样本数量计算

#### 情况1：理想情况（每场洪水全部有效）

如果每场洪水的720小时数据全部有效，使用滑动窗口（步长=1）：

```
每场洪水可生成的样本数 = 720 - 96 + 1 = 625个样本

总样本数 = 612场 × 625样本/场 = 382,500个样本
```

#### 情况2：实际情况（考虑洪水事件位置）

根据代码逻辑（`_create_sliding_window_samples`），实际样本数取决于：

1. **洪水事件的位置**：样本必须包含洪水事件
2. **有效数据范围**：不能有NaN值
3. **滑动窗口约束**：窗口不能超出数据边界

**估算方法**：
- 如果每场洪水事件平均覆盖200小时
- 滑动窗口可以在洪水事件前后移动
- 每场洪水可能生成：**200-500个样本**（取决于洪水事件长度和位置）

**保守估计总样本数**：
```
总样本数 ≈ 612场 × 300样本/场 ≈ 183,600个样本
```

### 1.4 Batch数量计算

```
总batch数 = 总样本数 / batch_size
          = 183,600 / 128
          ≈ 1,434个batch
```

---

## 二、完整数据流程图

### 2.1 阶段1：数据加载和样本生成

```
┌─────────────────────────────────────────────────────────────────┐
│                    阶段1: 数据加载和样本生成                      │
└─────────────────────────────────────────────────────────────────┘

原始数据
    │
    ├─→ 612场洪水事件
    │   ├─→ 场次1: [0:720]  (720小时)
    │   ├─→ 场次2: [0:720]  (720小时)
    │   ├─→ ...
    │   └─→ 场次612: [0:720]  (720小时)
    │
    └─→ 每场洪水提取样本（滑动窗口，步长=1）
        │
        ├─→ 场次1:
        │   ├─→ 样本1: [0:96]     (warmup[0:24] + forecast[24:96])
        │   ├─→ 样本2: [1:97]     (warmup[1:25] + forecast[25:97])
        │   ├─→ 样本3: [2:98]
        │   ├─→ ...
        │   └─→ 样本625: [624:720]  (如果全部有效)
        │
        ├─→ 场次2:
        │   └─→ 类似...
        │
        └─→ ... (共612场)

总样本数: 约183,600个样本（估算）
    │
    └─→ DataLoader (batch_size=128)
        │
        └─→ 每个batch: 128个样本
            │
            └─→ 总batch数: 约1,434个
```

### 2.2 阶段2：单个样本的数据结构

```
单个样本（从lookup_table获取）:
    │
    ├─→ basin_idx: 流域索引 (0-611)
    ├─→ start_idx: 起始时间步
    └─→ actual_length: 实际长度 (通常=96)

数据提取:
    │
    ├─→ x_origin: [actual_length, 2]  (P, PET，未归一化)
    │   └─→ 例如: [96, 2]
    │
    ├─→ y_origin: [actual_length - warmup_length, 1]  (流量，未归一化)
    │   └─→ 例如: [72, 1]  (去掉24小时warmup)
    │
    ├─→ c: [20]  (静态属性，每个流域固定)
    │   └─→ 20个静态属性
    │
    └─→ z_train: [actual_length - warmup_length, features]  (归一化，用于LSTM)
        └─→ 例如: [72, 22]  (P, PET归一化 + 20个静态属性)
```

### 2.3 阶段3：Batch数据维度

```
一个Batch (batch_size=128):
    │
    ├─→ x_train: [96, 128, 22]  (未归一化)
    │   ├─→ 时间步: 96 (warmup=24 + forecast=72)
    │   ├─→ 样本数: 128
    │   └─→ 特征: 22 (P, PET + 20个静态属性)
    │
    ├─→ z_train: [72, 128, 22]  (归一化，用于LSTM)
    │   ├─→ 时间步: 72 (去掉warmup，只有forecast部分)
    │   ├─→ 样本数: 128
    │   └─→ 特征: 22 (归一化的P, PET + 20个静态属性)
    │
    └─→ y_train: [72, 128, 1]  (目标流量，未归一化)
        ├─→ 时间步: 72 (去掉warmup)
        ├─→ 样本数: 128
        └─→ 输出: 1 (流量)
```

---

## 三、完整前向传播流程

### 3.1 输入数据

```
Batch输入:
    │
    ├─→ x_train: [96, 128, 22]  (未归一化: P, PET, 20个静态属性)
    └─→ z_train: [72, 128, 22]  (归一化: P, PET归一化, 20个静态属性)
```

### 3.2 LSTM参数生成

```
z_train [72, 128, 22]
    │
    ├─→ [步骤1] 输入全连接层 (linearIn)
    │   │
    │   ├─→ Linear(22 → 64)
    │   └─→ ReLU激活
    │
    │   输出: [72, 128, 64]
    │
    ├─→ [步骤2] LSTM处理序列
    │   │
    │   ├─→ 时间步0: z[0] → LSTM → h[0], c[0] → out[0]
    │   ├─→ 时间步1: z[1] + h[0] → LSTM → h[1], c[1] → out[1]
    │   ├─→ 时间步2: z[2] + h[1] → LSTM → h[2], c[2] → out[2]
    │   ├─→ ...
    │   └─→ 时间步71: z[71] + h[70] → LSTM → h[71], c[71] → out[71]
    │
    │   注意: 所有时间步使用同一个LSTM模型（共享权重）
    │
    │   输出: [72, 128, 64]  (每个时间步的隐藏状态)
    │
    ├─→ [步骤3] 输出全连接层 (linearOut)
    │   │
    │   ├─→ Linear(64 → 15)
    │   └─→ 无激活（直接输出）
    │
    │   输出: gen [72, 128, 15]  (每个时间步的15个新安江参数)
    │
    ├─→ [步骤4] 参数限制
    │   │
    │   ├─→ sigmoid(gen) 或 clamp(gen)
    │   └─→ 确保参数在[0, 1]范围
    │
    │   输出: params_ [72, 128, 15]
    │
    └─→ [步骤5] 选择参数
        │
        └─→ params = params_[-1, :, :]  # 取最后一个时间步
            │
            输出: params [128, 15]  (128个样本，每个15个参数)
```

### 3.3 参数反归一化

```
params [128, 15]  (归一化参数，范围[0,1])
    │
    └─→ 反归一化到物理范围
        │
        ├─→ K = k_scale[0] + params[:, 0] * (k_scale[1] - k_scale[0])
        │   └─→ 范围: [0.5, 1.5]
        │
        ├─→ B = b_scale[0] + params[:, 1] * (b_scale[1] - b_scale[0])
        │   └─→ 范围: [0.1, 0.4]
        │
        ├─→ IM = im_scale[0] + params[:, 2] * (im_scale[1] - im_scale[0])
        │   └─→ 范围: [0.0, 0.1]
        │
        └─→ ... (共15个参数)
            │
            输出: 物理参数 [128, 15]
```

### 3.4 新安江模型计算

```
x_train [96, 128, 22]  (未归一化)
    │
    └─→ 提取P和PET: x_train[:, :, :2] → [96, 128, 2]
        │
        └─→ 新安江模型 (Xaj4Dpl)
            │
            ├─→ [步骤1] 预热期处理 (前24小时)
            │   │
            │   ├─→ p_and_e_warmup = x_train[0:24, :, :2]  # [24, 128, 2]
            │   │
            │   └─→ with torch.no_grad():  # 不计算梯度
            │       │
            │       └─→ 初始化状态变量:
            │           ├─→ 土壤含水量: wu0, wl0, wd0
            │           ├─→ 自由水蓄量: s0
            │           ├─→ 产流面积: fr0
            │           └─→ 线性水库状态: qi0, qg0
            │
            ├─→ [步骤2] 实际计算 (后72小时)
            │   │
            │   └─→ inputs = x_train[24:96, :, :2]  # [72, 128, 2]
            │       │
            │       └─→ 对每个时间步 t (0到71):
            │           │
            │           ├─→ [2.1] 产流计算 (xaj_generation)
            │           │   │
            │           │   ├─→ 计算蒸发: eu, el, ed = calculate_evap(...)
            │           │   ├─→ 计算净降水: pe = prcp - e
            │           │   ├─→ 计算产流量: r, rim = calculate_prcp_runoff(...)
            │           │   └─→ 更新土壤水: wu, wl, wd = calculate_w_storage(...)
            │           │
            │           ├─→ [2.2] 分水源 (xaj_sources)
            │           │   │
            │           │   ├─→ 地表径流: rs = f(pe, r, sm, ex, ...)
            │           │   ├─→ 壤中流: ri = f(s, ki, ...)
            │           │   └─→ 地下径流: rg = f(s, kg, ...)
            │           │
            │           └─→ [2.3] 汇流计算
            │               │
            │               ├─→ 地表径流汇流: qs = KernelConv(rs)
            │               ├─→ 壤中流汇流: qi = linear_reservoir(ri, ci)
            │               ├─→ 地下径流汇流: qg = linear_reservoir(rg, cg)
            │               └─→ 总流量: q[t] = qs[t] + qi[t] + qg[t]
            │
            └─→ 输出: q_sim [72, 128, 1]  (模拟流量)
```

### 3.5 损失计算

```
q_sim [72, 128, 1]  (预测值)
    │
    └─→ 与 y_train [72, 128, 1]  (真实值) 比较
        │
        └─→ loss = criterion(q_sim, y_train)
            │
            输出: loss (标量)
```

---

## 四、反向传播和参数更新

### 4.1 反向传播流程

```
loss (标量)
    │
    ├─→ loss.backward()  # 自动计算所有梯度
    │
    ├─→ [梯度1] 损失对输出的梯度
    │   │
    │   └─→ ∂loss/∂q_sim = 2 * (q_sim - y_train) / batch_size
    │
    ├─→ [梯度2] 通过新安江模型传播
    │   │
    │   ├─→ ∂loss/∂params = Σ_t (∂loss/∂q[t] * ∂q[t]/∂params)
    │   │   │
    │   │   └─→ 对每个时间步和每个参数:
    │   │       ├─→ ∂loss/∂K = Σ_t (∂loss/∂q[t] * ∂q[t]/∂K)
    │   │       ├─→ ∂loss/∂B = Σ_t (∂loss/∂q[t] * ∂q[t]/∂B)
    │   │       └─→ ... (15个参数)
    │   │
    │   └─→ 注意: 新安江模型的所有操作都是可微的
    │
    ├─→ [梯度3] 通过参数处理传播
    │   │
    │   ├─→ ∂loss/∂params_ = ∂loss/∂params * (scale[1] - scale[0])
    │   │
    │   └─→ ∂loss/∂gen = ∂loss/∂params_ * sigmoid'(gen)
    │       └─→ sigmoid'(x) = sigmoid(x) * (1 - sigmoid(x))
    │
    ├─→ [梯度4] 通过LSTM传播 (BPTT)
    │   │
    │   ├─→ 时间步71: ∂loss/∂h[71] = ∂loss/∂gen[71] * W_out^T
    │   ├─→ 时间步70: ∂loss/∂h[70] = ∂loss/∂h[71] * ∂h[71]/∂h[70] + ...
    │   ├─→ ...
    │   └─→ 时间步0: ∂loss/∂h[0] = ∂loss/∂h[1] * ∂h[1]/∂h[0] + ...
    │
    │   └─→ 计算LSTM参数梯度:
    │       ├─→ ∂loss/∂W_lstm = Σ_t (∂loss/∂h[t] * ∂h[t]/∂W_lstm)
    │       └─→ ∂loss/∂b_lstm = Σ_t (∂loss/∂h[t] * ∂h[t]/∂b_lstm)
    │
    └─→ [梯度5] 通过全连接层传播
        │
        ├─→ ∂loss/∂W_out = Σ_t (∂loss/∂h[t] * out_lstm[t]^T)
        ├─→ ∂loss/∂b_out = Σ_t (∂loss/∂h[t])
        ├─→ ∂loss/∂W_in = Σ_t (∂loss/∂x0[t] * z[t]^T)
        └─→ ∂loss/∂b_in = Σ_t (∂loss/∂x0[t])
```

### 4.2 参数更新

```
所有参数的梯度 (∂loss/∂W, ∂loss/∂b, ...)
    │
    └─→ optimizer.step()
        │
        ├─→ W_lstm_new = W_lstm_old - lr * ∂loss/∂W_lstm
        ├─→ b_lstm_new = b_lstm_old - lr * ∂loss/∂b_lstm
        ├─→ W_in_new = W_in_old - lr * ∂loss/∂W_in
        ├─→ b_in_new = b_in_old - lr * ∂loss/∂b_in
        ├─→ W_out_new = W_out_old - lr * ∂loss/∂W_out
        └─→ b_out_new = b_out_old - lr * ∂loss/∂b_out
        │
        输出: 更新后的LSTM参数
```

---

## 五、训练循环完整流程

### 5.1 一个Epoch的训练流程

```
Epoch 1
    │
    ├─→ Batch 1 (样本0-127)
    │   ├─→ 前向传播 → loss1
    │   ├─→ 反向传播 → 梯度1
    │   └─→ 参数更新 → 参数1
    │
    ├─→ Batch 2 (样本128-255)
    │   ├─→ 前向传播 → loss2
    │   ├─→ 反向传播 → 梯度2
    │   └─→ 参数更新 → 参数2
    │
    ├─→ ...
    │
    └─→ Batch 1434 (最后一批)
        ├─→ 前向传播 → loss1434
        ├─→ 反向传播 → 梯度1434
        └─→ 参数更新 → 参数1434
        │
        └─→ Epoch 1 完成
```

### 5.2 关键维度变化总结

```
原始数据: [612场, 720小时, features]
    ↓ (数据切片，滑动窗口)
样本数据: [183,600个样本, 96小时, features]
    ↓ (batch处理)
Batch数据: [1,434个batch, 128个样本/batch]
    ↓ (数据分割)
x_train: [96, 128, 22]  (warmup=24 + forecast=72, P+PET+20属性)
z_train: [72, 128, 22]  (去掉warmup，归一化)
y_train: [72, 128, 1]   (目标流量，去掉warmup)
    ↓ (LSTM处理)
gen: [72, 128, 15]  (每个时间步的15个参数)
    ↓ (选择最后一个时间步)
params: [128, 15]  (128个样本的15个参数)
    ↓ (新安江模型)
q_sim: [72, 128, 1]  (模拟流量)
    ↓ (损失计算)
loss: 标量
    ↓ (反向传播)
梯度: 所有参数的梯度
    ↓ (参数更新)
新参数: 更新后的LSTM参数
```

---

## 六、关键配置参数说明

### 6.1 数据配置（data_cfgs）

```python
data_cfgs = {
    "warmup_length": 24,        # 新安江模型预热期（24小时）
    "forecast_history": 0,      # Decoder-only模式，不需要历史输入
    "forecast_length": 72,      # 预测72小时（你设置的）
}
```

### 6.2 模型配置（model_hyperparam）

```python
model_hyperparam = {
    "warmup_length": 24,       # 新安江模型内部预热期（应与data_cfgs一致）
}
```

### 6.3 训练配置

```python
training_cfgs = {
    "batch_size": 128,         # 每个batch 128个样本
    "learning_rate": 0.001,    # 学习率（示例）
    "num_epochs": 100,         # 训练轮数（示例）
}
```

---

## 七、数据推进方式（滑动窗口）

### 7.1 单场洪水的样本生成

```
场次1 (720小时):
    │
    ├─→ 样本1: [0:96]     (warmup[0:24] + forecast[24:96])
    │   ├─→ x_train: [0:96, 2]      (P, PET)
    │   ├─→ z_train: [24:96, 22]   (归一化，去掉warmup)
    │   └─→ y_train: [24:96, 1]    (流量，去掉warmup)
    │
    ├─→ 样本2: [1:97]     (warmup[1:25] + forecast[25:97])
    │   ├─→ x_train: [1:97, 2]
    │   ├─→ z_train: [25:97, 22]
    │   └─→ y_train: [25:97, 1]
    │
    ├─→ 样本3: [2:98]
    │   └─→ ...
    │
    ├─→ ...
    │
    └─→ 样本625: [624:720]  (如果全部有效)
        └─→ ...
```

### 7.2 滑动窗口示意图

```
时间轴: 0    24   48   72   96   ...   624  648  672  696  720
        |----|----|----|----|----|----|----|----|----|----|
        
样本1:  ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
        ↑    ↑                                        ↑
        │    │                                        └─ 96
        │    └─ warmup结束，forecast开始
        └─ 0

样本2:   ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
         ↑    ↑                                        ↑
         │    │                                        └─ 97
         │    └─ warmup结束，forecast开始
         └─ 1

样本3:    ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
          ↑    ↑                                        ↑
          │    │                                        └─ 98
          │    └─ warmup结束，forecast开始
          └─ 2

图例:
█ = warmup期 (24小时，用于初始化新安江模型状态)
░ = forecast期 (72小时，用于预测和训练)
```

---

## 八、总结

### 8.1 关键数字

- **总场次**: 612场洪水
- **每场时长**: 720小时
- **每场样本数**: 约300-625个（取决于有效数据范围）
- **总样本数**: 约183,600个（估算）
- **batch_size**: 128
- **总batch数**: 约1,434个
- **序列长度**: 96小时（24 warmup + 72 forecast）
- **LSTM输入**: 72小时（去掉warmup）
- **新安江模型输入**: 96小时（包含warmup）
- **输出**: 72小时流量预测

### 8.2 数据流关键点

1. **数据加载**: 从612场洪水中提取样本，使用滑动窗口
2. **Batch处理**: 每个batch包含128个样本
3. **LSTM输入**: 72小时归一化数据（P, PET, 20个静态属性）
4. **新安江模型输入**: 96小时未归一化数据（P, PET）
5. **输出对齐**: 预测值和真实值都是72小时（去掉warmup）

### 8.3 训练推进方式

- **滑动窗口**: 步长为1，每次移动1小时
- **样本重叠**: 相邻样本有95小时重叠（96-1=95）
- **数据利用**: 最大化利用每场洪水的数据

---

**注意**: 以上计算基于假设的配置参数。请根据你的实际配置（warmup_length, forecast_history）调整计算。

