# 可微分新安江模型可视化流程图

## 一、240小时数据样本提取示意图

```
时间轴: 0    30   60   90   120  150  180  210  240 (小时)
        |----|----|----|----|----|----|----|----|
        
配置:
- warmup_length = 30小时
- forecast_history = 30小时  
- forecast_length = 1小时
- 总样本数 = 240 - 30 - 30 - 1 + 1 = 180个

样本1 (idx=30):
┌─────────────────────────────────────────────┐
│ warmup: [0:30]    ████████████████████████  │
│ input:  [30:60]   ░░░░░░░░░░░░░░░░░░░░░░░░  │
│ target: [60:61]   ▒                         │
└─────────────────────────────────────────────┘

样本2 (idx=31):
┌─────────────────────────────────────────────┐
│ warmup: [1:31]    ████████████████████████  │
│ input:  [31:61]   ░░░░░░░░░░░░░░░░░░░░░░░░  │
│ target: [61:62]   ▒                         │
└─────────────────────────────────────────────┘

样本3 (idx=32):
┌─────────────────────────────────────────────┐
│ warmup: [2:32]    ████████████████████████  │
│ input:  [32:62]   ░░░░░░░░░░░░░░░░░░░░░░░░  │
│ target: [62:63]   ▒                         │
└─────────────────────────────────────────────┘

... (共180个样本，每次滑动1小时)

样本180 (idx=209):
┌─────────────────────────────────────────────┐
│ warmup: [179:209] ████████████████████████  │
│ input:  [209:239] ░░░░░░░░░░░░░░░░░░░░░░░░  │
│ target: [239:240] ▒                         │
└─────────────────────────────────────────────┘

图例:
█ = warmup期 (不参与训练，仅初始化状态)
░ = input期 (LSTM和新安江模型的输入)
▒ = target期 (预测目标，用于计算损失)
```

## 二、LSTM结构详细图

```
输入: z [31, 32, 10]
      │
      │  ┌─────────────────────────────────────┐
      └─→│  输入全连接层 (linearIn)            │
         │  Linear(10 → 64)                    │
         │  ReLU激活                           │
         └─────────────────────────────────────┘
          输出: [31, 32, 64]
          │
          │  ┌─────────────────────────────────────┐
          └─→│  LSTM层 (共享模型)                   │
             │                                      │
             │  时间步0:                            │
             │    z[0] → LSTM → h[0], c[0]          │
             │                                      │
             │  时间步1:                            │
             │    z[1] + h[0] → LSTM → h[1], c[1]  │
             │                                      │
             │  时间步2:                            │
             │    z[2] + h[1] → LSTM → h[2], c[2]  │
             │                                      │
             │  ...                                 │
             │                                      │
             │  时间步30:                           │
             │    z[30] + h[29] → LSTM → h[30]     │
             │                                      │
             │  注意: 所有时间步使用同一个LSTM模型 │
             │        (权重W_lstm, b_lstm共享)     │
             └─────────────────────────────────────┘
              输出: [31, 32, 64]
              │
              │  ┌─────────────────────────────────────┐
              └─→│  输出全连接层 (linearOut)           │
                 │  Linear(64 → 15)                    │
                 │  无激活函数                         │
                 └─────────────────────────────────────┘
                  输出: gen [31, 32, 15]
                  │
                  │  ┌─────────────────────────────────────┐
                  └─→│  参数限制                           │
                     │  sigmoid(gen) 或 clamp(gen)         │
                     │  确保参数在[0, 1]范围               │
                     └─────────────────────────────────────┘
                      输出: params_ [31, 32, 15]
                      │
                      │  ┌─────────────────────────────────────┐
                      └─→│  选择参数                           │
                         │  params = params_[-1, :, :]         │
                         │  取最后一个时间步的参数             │
                         └─────────────────────────────────────┘
                          输出: params [32, 15]
                          (32个样本，每个15个参数)
```

## 三、完整前向传播流程图

```
┌──────────────────────────────────────────────────────────────┐
│                    数据输入                                    │
└──────────────────────────────────────────────────────────────┘
         │
         ├─→ x_train [61, 32, 2]  (未归一化: P, PET)
         │
         └─→ z_train [61, 32, 10] (归一化: 输入特征)
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│                    LSTM参数生成                               │
└──────────────────────────────────────────────────────────────┘
         │
         ├─→ linearIn: [61,32,10] → [61,32,64]
         │
         ├─→ LSTM: [61,32,64] → [61,32,64]
         │   │
         │   ├─→ t=0: z[0] → h[0]
         │   ├─→ t=1: z[1] + h[0] → h[1]
         │   ├─→ t=2: z[2] + h[1] → h[2]
         │   └─→ ... (共享LSTM模型)
         │
         ├─→ linearOut: [61,32,64] → [61,32,15]
         │
         ├─→ sigmoid: [61,32,15] → [61,32,15]
         │
         └─→ 选择: params = params_[-1] → [32,15]
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│                   参数反归一化                                │
└──────────────────────────────────────────────────────────────┘
         │
         ├─→ K = 0.5 + params[:,0] * 1.0  (范围: [0.5, 1.5])
         ├─→ B = 0.1 + params[:,1] * 0.3  (范围: [0.1, 0.4])
         ├─→ IM = 0.0 + params[:,2] * 0.1 (范围: [0.0, 0.1])
         └─→ ... (共15个参数)
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│                   新安江模型计算                               │
└──────────────────────────────────────────────────────────────┘
         │
         └─→ 对每个时间步 t (0到30):
             │
             ├─→ 产流计算
             │   ├─→ 蒸发: eu, el, ed
             │   ├─→ 净降水: pe = P - e
             │   ├─→ 产流量: r, rim
             │   └─→ 更新土壤水: wu, wl, wd
             │
             ├─→ 分水源
             │   ├─→ 地表径流: rs
             │   ├─→ 壤中流: ri
             │   └─→ 地下径流: rg
             │
             └─→ 汇流
                 ├─→ qs = KernelConv(rs)
                 ├─→ qi = linear_reservoir(ri)
                 ├─→ qg = linear_reservoir(rg)
                 └─→ q[t] = qs[t] + qi[t] + qg[t]
                  │
                  ▼
┌──────────────────────────────────────────────────────────────┐
│                   输出流量                                    │
└──────────────────────────────────────────────────────────────┘
         │
         └─→ q_sim [31, 32, 1]  (去掉warmup后的31个时间步)
```

## 四、反向传播详细流程图

```
┌──────────────────────────────────────────────────────────────┐
│                    损失计算                                    │
└──────────────────────────────────────────────────────────────┘
         │
         ├─→ q_sim [31, 32, 1]  (预测值)
         ├─→ y_true [31, 32, 1]  (真实值)
         │
         └─→ loss = mean((q_sim - y_true)^2)
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│                    loss.backward()                            │
│                    自动计算梯度                               │
└──────────────────────────────────────────────────────────────┘
         │
         ├─→ [梯度1] ∂loss/∂q_sim
         │   │
         │   └─→ = 2 * (q_sim - y_true) / batch_size
         │
         ├─→ [梯度2] 通过新安江模型传播
         │   │
         │   ├─→ ∂loss/∂q[t] → ∂loss/∂rs[t], ∂loss/∂ri[t], ∂loss/∂rg[t]
         │   │
         │   ├─→ ∂loss/∂rs[t] → ∂loss/∂r[t] → ∂loss/∂K, ∂loss/∂B, ...
         │   │
         │   └─→ 对每个时间步累积: ∂loss/∂params = Σ_t (∂loss/∂param_t)
         │
         ├─→ [梯度3] 通过参数处理传播
         │   │
         │   ├─→ ∂loss/∂params → ∂loss/∂params_
         │   │   (通过反归一化公式)
         │   │
         │   └─→ ∂loss/∂params_ → ∂loss/∂gen
         │       (通过sigmoid: ∂sigmoid/∂x = sigmoid(x)*(1-sigmoid(x)))
         │
         ├─→ [梯度4] 通过LSTM传播 (BPTT)
         │   │
         │   ├─→ 时间步30: ∂loss/∂h[30] = ∂loss/∂gen[30] * W_out^T
         │   │
         │   ├─→ 时间步29: ∂loss/∂h[29] = ∂loss/∂h[30] * ∂h[30]/∂h[29]
         │   │            + ∂loss/∂gen[29] * W_out^T
         │   │
         │   ├─→ 时间步28: ∂loss/∂h[28] = ∂loss/∂h[29] * ∂h[29]/∂h[28]
         │   │            + ∂loss/∂gen[28] * W_out^T
         │   │
         │   ├─→ ...
         │   │
         │   └─→ 时间步0: ∂loss/∂h[0] = ∂loss/∂h[1] * ∂h[1]/∂h[0]
         │              + ∂loss/∂gen[0] * W_out^T
         │
         │   └─→ 计算LSTM参数梯度:
         │       ├─→ ∂loss/∂W_lstm = Σ_t (∂loss/∂h[t] * ∂h[t]/∂W_lstm)
         │       └─→ ∂loss/∂b_lstm = Σ_t (∂loss/∂h[t] * ∂h[t]/∂b_lstm)
         │
         └─→ [梯度5] 通过全连接层传播
             │
             ├─→ ∂loss/∂W_out = Σ_t (∂loss/∂h[t] * out_lstm[t]^T)
             ├─→ ∂loss/∂b_out = Σ_t (∂loss/∂h[t])
             ├─→ ∂loss/∂W_in = Σ_t (∂loss/∂x0[t] * z[t]^T)
             └─→ ∂loss/∂b_in = Σ_t (∂loss/∂x0[t])
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│                   参数更新                                    │
└──────────────────────────────────────────────────────────────┘
         │
         └─→ optimizer.step()
             │
             ├─→ W_lstm = W_lstm - lr * ∂loss/∂W_lstm
             ├─→ b_lstm = b_lstm - lr * ∂loss/∂b_lstm
             ├─→ W_in = W_in - lr * ∂loss/∂W_in
             ├─→ b_in = b_in - lr * ∂loss/∂b_in
             ├─→ W_out = W_out - lr * ∂loss/∂W_out
             └─→ b_out = b_out - lr * ∂loss/∂b_out
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│                   下一个batch                                 │
│                   重复上述过程                                 │
└──────────────────────────────────────────────────────────────┘
```

## 五、梯度传播路径图

```
损失值 (loss)
    │
    │ ∂loss/∂q = 2*(q-y)
    ▼
流量输出 q_sim [31, 32, 1]
    │
    │ 通过新安江模型的所有计算
    │ (产流、分水源、汇流)
    ▼
新安江参数 [32, 15]
    │ K, B, IM, UM, LM, DM, C, SM, EX, KI, KG, A, THETA, CI, CG
    │
    │ ∂loss/∂params = Σ_t (∂loss/∂q[t] * ∂q[t]/∂params)
    ▼
归一化参数 params [32, 15]
    │
    │ ∂loss/∂params_ = ∂loss/∂params * (scale[1] - scale[0])
    ▼
LSTM输出 gen [31, 32, 15]
    │
    │ ∂loss/∂gen = ∂loss/∂params_ * sigmoid'(gen)
    │              = ∂loss/∂params_ * sigmoid(gen) * (1 - sigmoid(gen))
    ▼
LSTM隐藏状态 h [31, 32, 64]
    │
    │ BPTT: 从时间步30反向传播到时间步0
    │ ∂loss/∂h[t] = ∂loss/∂h[t+1] * ∂h[t+1]/∂h[t] + ∂loss/∂gen[t] * W_out^T
    ▼
LSTM输入 x0 [31, 32, 64]
    │
    │ ∂loss/∂x0 = ∂loss/∂h * (通过LSTM内部计算)
    ▼
linearIn输出 [31, 32, 64]
    │
    │ ∂loss/∂linearIn_out = ∂loss/∂x0
    ▼
原始输入 z [31, 32, 10]
    │
    │ ∂loss/∂z = ∂loss/∂linearIn_out * W_in^T
    ▼
LSTM参数梯度
    │
    ├─→ ∂loss/∂W_lstm = Σ_t (∂loss/∂h[t] * ∂h[t]/∂W_lstm)
    ├─→ ∂loss/∂b_lstm = Σ_t (∂loss/∂h[t] * ∂h[t]/∂b_lstm)
    ├─→ ∂loss/∂W_in = Σ_t (∂loss/∂x0[t] * z[t]^T)
    ├─→ ∂loss/∂b_in = Σ_t (∂loss/∂x0[t])
    ├─→ ∂loss/∂W_out = Σ_t (∂loss/∂h[t] * out_lstm[t]^T)
    └─→ ∂loss/∂b_out = Σ_t (∂loss/∂h[t])
    │
    ▼
参数更新
    │
    └─→ W_new = W_old - learning_rate * ∂loss/∂W
```

## 六、训练迭代过程图

```
Epoch 1
    │
    ├─→ Batch 1
    │   ├─→ 前向传播 → loss1
    │   ├─→ 反向传播 → 梯度1
    │   └─→ 参数更新 → 参数1
    │
    ├─→ Batch 2
    │   ├─→ 前向传播 → loss2
    │   ├─→ 反向传播 → 梯度2
    │   └─→ 参数更新 → 参数2
    │
    └─→ ... (所有batch)
        │
        └─→ Epoch 1 完成

Epoch 2
    │
    ├─→ Batch 1 (使用更新后的参数)
    │   ├─→ 前向传播 → loss1' (应该更小)
    │   ├─→ 反向传播 → 梯度1'
    │   └─→ 参数更新 → 参数1'
    │
    └─→ ... (所有batch)
        │
        └─→ Epoch 2 完成

...

Epoch N
    │
    └─→ 参数已收敛
        │
        └─→ 最优LSTM参数
            │
            └─→ 可以生成最优的新安江参数
```

## 七、关键维度变化总结

```
原始数据: [240, features]
    ↓ 数据切片 (180个样本)
样本: [61, features]  (每个样本)
    ↓ Batch处理 (32个样本一批)
Batch: [61, 32, features]
    ↓ 数据分割
x_train: [61, 32, 2]   (P, PET)
z_train: [61, 32, 10]  (归一化特征)
y_train: [31, 32, 1]   (目标流量，去掉warmup)
    ↓ LSTM处理
gen: [61, 32, 15]       (每个时间步的15个参数)
    ↓ 选择最后一个时间步
params: [32, 15]       (32个样本的15个参数)
    ↓ 新安江模型
q_sim: [31, 32, 1]     (模拟流量，去掉warmup)
    ↓ 损失计算
loss: 标量
    ↓ 反向传播
梯度: 所有参数的梯度
    ↓ 参数更新
新参数: 更新后的LSTM参数
```

## 八、LSTM共享模型示意图

```
时间步0:  z[0]  ──┐
                  │
时间步1:  z[1]  ──┤
                  │
时间步2:  z[2]  ──┤
                  │
   ...            │
                  │
时间步30: z[30] ──┤
                  │
                  ▼
         ┌─────────────────┐
         │   同一个LSTM模型 │
         │  (共享权重参数)  │
         │                 │
         │  W_lstm (固定)   │
         │  b_lstm (固定)   │
         └─────────────────┘
                  │
         ┌────────┴────────┐
         │                 │
         ▼                 ▼
      h[0]              h[30]
      c[0]              c[30]
      out[0]            out[30]
         │                 │
         └────────┬────────┘
                  │
                  ▼
            gen [31, 32, 15]
            
注意: 
- 所有时间步使用同一个LSTM模型
- 但每个时间步的隐藏状态(h, c)是不同的
- 隐藏状态会传递到下一个时间步
```

这个可视化流程图展示了从数据输入到参数更新的完整过程，希望能帮助你更好地理解模型的运行机制！

